cubes:
- name: open_lines
  sql_table: dbo.SOP10200
  data_source: default

  joins:
  - name: open_documents
    relationship: many_to_one
    sql: "{open_documents}.SOPTYPE = {open_lines}.SOPTYPE AND {open_documents}.SOPNUMBE = {open_lines}.SOPNUMBE"

  dimensions:
  #  - name: company
  #   sql: self._company
  #   type: string

  # IDENTIFIERS ##################################################################

  - name: document_type
    sql: "{CUBE}.SOPTYPE"
    type: number
    public: true
    primary_key: true

  - name: external_number
    sql: "{CUBE}.SOPNUMBE"
    type: string
    public: true
    primary_key: true

  - name: item_sequence
    sql: "{CUBE}.number"
    type: string
    public: true
    primary_key: true

  - name: component_sequence
    sql: "{CUBE}.CMPNTSEQ"
    type: number
    public: true
    primary_key: true

  - name: document_class
    type: string
    public: false
    case:
      when:
      - sql: "{CUBE}.SOPTYPE = 1"
        label: 'QUOTE'
      - sql: "{CUBE}.SOPTYPE = 2"
        label: 'ORDER'
      - sql: "{CUBE}.SOPTYPE = 3"
        label: 'INVOICE'
      - sql: "{CUBE}.SOPTYPE = 4"
        label: 'RETURN'
      - sql: "{CUBE}.SOPTYPE = 5"
        label: 'BACK_ORDER'
      - sql: "{CUBE}.SOPTYPE = 6"
        label: 'FULFILLMENT_ORDER'
      else:
        label: "UNKNOWN"

  - name: external_id
    sql: "CONCAT({document_external_id}, '|', {CUBE}.LNITMSEQ, '|', COALESCE({CUBE}.CMPNTSEQ, 0))"
    type: string

  - name: document_external_id
    sql: "CONCAT(TRIM({document_class}), '|', TRIM({CUBE}.SOPNUMBE))"
    type: string

  # - name: parent_line_external_id
  #   sql: "{CUBE}.parent_line_ext_id"
  #   type: string

  # ITEM ######################################################################

  - name: item_number
    sql: "{CUBE}.ITEMNMBR"
    type: string

  - name: item_description
    sql: "{CUBE}.ITEMDESC"
    type: string

  - name: is_noninventory
    sql: "{CUBE}.NONINVEN"
    type: boolean

  - name: is_dropship
    sql: "{CUBE}.DROPSHIP"
    type: boolean

  - name: package_udf_val # Effectively comes from a config (Sales_Line_Item_Package_Smart_Field).
    sql: TRIM('')
    type: string
    public: false

  # These are going to need some more work.
  - name: is_package
    type: string
    case:
      when:
      - sql: "({package_udf_val} IS NOT NULL AND LEN({package_udf_val}) > 0) AND {CUBE}.ITEMNMBR IS NOT NULL AND {CUBE}.CMPNTSEQ IS NULL AND UPPER({CUBE}.ITEMNMBR) = UPPER({package_udf_val})"
        label: "true"
      else:
        label: "false"

  - name: is_component
    type: string
    case:
      when:
      - sql: "({package_udf_val} IS NOT NULL AND LEN({package_udf_val}) > 0) AND {CUBE}.ITEMNMBR IS NOT NULL AND {CUBE}.CMPNTSEQ IS NULL AND UPPER({CUBE}.ITEMNMBR) = UPPER({package_udf_val})"
        label: "false"
      else:
        label: "true"

  - name: uofm
    sql: "{CUBE}.UOFM"
    type: string

  # FINANCIALS & QUANTITIES ##################################################################

  - name: udf_cost # Effectively comes from a config (Margin_Cost_Field).
    sql: "0"
    type: number
    public: false

  - name: unit_cost
    type: number
    case:
      when:
      - sql: "{udf_cost} IS NOT NULL AND {udf_cost} > 0"
        label:
          sql: "{udf_cost}"
      else:
        label:
          sql: "{CUBE}.UNITCOST"

  - name: extended_cost
    type: number
    case:
      when:
      - sql: "{udf_cost} IS NOT NULL"
        label:
          sql: "{unit_cost} * QUANTITY"
      else:
        label:
          sql: "{CUBE}.EXTDCOST"

  - name: base_quantity_factor
    sql: "{CUBE}.QTYBSUOM"
    type: number
    public: false

  - name: base_quantity
    type: number
    public: false
    case:
      when:
      - sql: "{base_quantity_factor} IS NOT NULL AND {base_quantity_factor} > 0"
        label:
          sql: "{CUBE}.QUANTITY * {base_quantity_factor}"
      else:
        label: "0"

  - name: base_unit_cost
    type: number
    case:
      when:
      - sql: "{base_quantity} IS NOT NULL AND {base_quantity} > 0"
        label:
          sql: "{extended_cost} / {base_quantity}"
      else:
        label: "0"

  - name: unit_price
    sql: "{CUBE}.UNITPRCE"
    type: number

  - name: extended_price
    sql: "{CUBE}.XTNDPRCE"
    type: number

  - name: base_unit_price
    type: number
    case:
      when:
      - sql: "{base_quantity} IS NOT NULL AND {base_quantity} > 0"
        label:
          sql: "{CUBE}.XTNDPRCE / {base_quantity}"
      else:
        label: "0"

  - name: tax_amount
    sql: "{CUBE}.TAXAMNT"
    type: number

  - name: discount_amount
    sql: "{CUBE}.TRDISAMT"
    type: number

  - name: quantity
    sql: "{CUBE}.QUANTITY"
    type: number

  - name: quantity_allocated
    sql: "{CUBE}.ATYALLOC"
    type: number

  - name: quantity_returned
    sql: "{CUBE}.QTYRTRND"
    type: number

  # OTHER ##################################################

  - name: price_level_id
    sql: "{CUBE}.PRCLEVEL"
    type: string

  - name: warehouse_id
    sql: "{CUBE}.LOCNCODE"
    type: string

  - name: required_ship_date
    sql: "{CUBE}.ReqShipDate"
    type: time


  - name: fulfillment_date
    sql: "{CUBE}.FUFILDAT"
    type: time


  - name: actual_ship_date
    sql: "{CUBE}.ACTLSHIP"
    type: time


  - name: markdown_amount
    sql: "{CUBE}.MRKDNAMT"
    type: number

  - name: markdown_percent
    type: number
    case:
      when:
      - sql: "{CUBE}.MRKDNPCT IS NOT NULL AND {CUBE}.MRKDNPCT > 0"
        label:
          sql: "{CUBE}.MRKDNPCT / 100"
      else:
        label: "0"

  measures:
  - name: sum_extended_cost
    sql: "{CUBE.extended_cost}"
    type: sum
    format: currency

  pre_aggregations:
  - name: main
    dimensions:
    - open_lines.actual_ship_date
    - open_lines.base_quantity
    - open_lines.base_quantity_factor
    - open_lines.base_unit_cost
    - open_lines.base_unit_price
    - open_lines.discount_amount
    - open_lines.document_class
    - open_lines.document_external_id
    - open_lines.extended_cost
    - open_lines.extended_price
    - open_lines.external_id
    - open_lines.fulfillment_date
    - open_lines.is_component
    - open_lines.is_dropship
    - open_lines.is_noninventory
    - open_lines.is_package
    - open_lines.item_description
    - open_lines.item_number
    - open_lines.markdown_amount
    - open_lines.markdown_percent
    - open_lines.price_level_id
    - open_lines.quantity
    - open_lines.quantity_allocated
    - open_lines.quantity_returned
    - open_lines.required_ship_date
    - open_lines.tax_amount
    - open_lines.unit_cost
    - open_lines.unit_price
    - open_lines.uofm
    - open_lines.warehouse_id

  - name: sum_extended_cost_by_document
    dimensions:
    - CUBE.document_type
    - CUBE.external_number
    measures:
    - CUBE.sum_extended_cost

# Pre-aggregation definitions go here.
# Learn more in the documentation: https://cube.dev/docs/caching/pre-aggregations/getting-started

