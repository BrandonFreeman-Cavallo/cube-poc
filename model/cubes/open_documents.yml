cubes:
- name: open_documents
  sql_table: dbo.SOP10100
  data_source: default

  joins:
  - name: open_lines
    relationship: one_to_many
    sql: "{open_documents}.SOPTYPE = {open_lines}.SOPTYPE AND {open_documents}.SOPNUMBE = {open_lines}.SOPNUMBE"

  dimensions:
  - name: document_type
    sql: "{CUBE}.SOPTYPE"
    type: number
    public: true
    primary_key: true

  - name: external_number
    sql: "{CUBE}.SOPNUMBE"
    type: string
    public: true
    primary_key: true

  - name: document_class
    type: string
    case:
      when:
      - sql: "{CUBE}.SOPTYPE = 1"
        label: QUOTE
      - sql: "{CUBE}.SOPTYPE = 2"
        label: ORDER
      - sql: "{CUBE}.SOPTYPE = 3"
        label: INVOICE
      - sql: "{CUBE}.SOPTYPE = 4"
        label: RETURN
      - sql: "{CUBE}.SOPTYPE = 5"
        label: BACK_ORDER
      - sql: "{CUBE}.SOPTYPE = 6"
        label: FULFILLMENT_ORDER

  - name: external_id
    sql: "CONCAT(TRIM({document_class}), '|', TRIM({CUBE}.SOPNUMBE))"
    type: string

  # - name: version
  #   sql:
  #   type: string

  - name: master_number
    sql: "{CUBE}.MSTRNUMB"
    type: string

  # - name: company
  #   sql:
  #   type: string

  - name: payment_terms_id
    sql: "{CUBE}.PYMTRMID"
    type: string

  - name: price_level_id
    sql: "{CUBE}.PRCLEVEL"
    type: string

  - name: warehouse_id
    sql: "{CUBE}.LOCNCODE"
    type: string

  - name: sales_territory_id
    sql: "{CUBE}.SALSTERR"
    type: string

  - name: orig_document_class
    type: string
    case:
      when:
      - sql: "ORIGTYPE = 1"
        label: QUOTE
      - sql: "ORIGTYPE = 2"
        label: ORDER
      - sql: "ORIGTYPE = 3"
        label: INVOICE
      - sql: "ORIGTYPE = 4"
        label: RETURN
      - sql: "ORIGTYPE = 5"
        label: BACK_ORDER
      - sql: "ORIGTYPE = 6"
        label: FULFILLMENT_ORDER

  - name: original_external_id
    type: string
    case:
      when:
      - sql: "LEN({orig_document_class}) > 0 AND LEN({CUBE}.ORIGNUMB) > 0"
        label:
          sql: "CONCAT({orig_document_class}, '|', {CUBE}.ORIGNUMB)"

  - name: orig_document_num
    sql: "{CUBE}.ORIGNUMB"
    type: string

  - name: subtotal
    sql: "{CUBE}.SUBTOTAL"
    type: number

  - name: discount
    type: number
    case:
      when:
      - sql: "{CUBE}.TRDISPCT > 0"
        label:
          sql: "({CUBE}.TRDISPCT / 100) * {CUBE}.SUBTOTAL"
      - sql: "{CUBE}.TRDISAMT > 0"
        label:
          sql: "{CUBE}.TRDISAMT"
      else:
        label: "0"

  - name: subtotal_net_discount
    sql: "{CUBE}.SUBTOTAL - {CUBE.discount}"
    type: number

  - name: tax
    sql: "{CUBE}.TAXAMNT"
    type: number

  - name: freight_taxable
    type: string
    case:
      when:
      - sql: "{CUBE}.FRGTTXBL = 1"
        label: TAXABLE
      - sql: "{CUBE}.FRGTTXBL = 2"
        label: NONTAXABLE
      - sql: "{CUBE}.FRGTTXBL = 3"
        label: BASE_ON_CUSTOMERS

  - name: freight
    sql: "{CUBE}.FRTAMNT"
    type: number

  - name: freight_tax_amount
    sql: "{CUBE}.FRTTXAMT"
    type: number

  - name: total
    sql: "{CUBE}.DOCAMNT"
    type: number

  - name: markdown_amount
    sql: "{CUBE}.MRKDNAMT"
    type: number

  - name: remaining_subtotal
    sql: "{CUBE}.REMSUBTO"
    type: number

  - name: misc_amount
    sql: "{CUBE}.MISCAMNT"
    type: number

  - name: tax_schedule_id
    sql: "{CUBE}.TAXSCHID"
    type: number

  - name: is_sli_tax_based_on_invoice_total
    sql: "{CUBE}.BSIVCTTL"
    type: boolean

  - name: taxable_tax_amount
    sql: "{CUBE}.TXBTXAMT"
    type: number

  - name: payment_amount_received
    sql: "{CUBE}.PYMTRCVD"
    type: number

  - name: deposit_amount_received
    sql: "{CUBE}.DEPRECVD"
    type: number

  - name: account_amount
    sql: "{CUBE}.ACCTAMNT"
    type: number

  - name: transaction_source
    sql: "{CUBE}.TRXSORCE"
    type: string

  # - name: current_queue_id
  #   sql: [computed: BACHNUMB, DOCID]	
  #   type: string

  # - name: is_posted
  #   sql: "NOW() > GLPOSTDT"
  #   type: boolean

  - name: is_void
    type: boolean
    case:
      when:
      - sql: "{CUBE}.VOIDSTTS = 1 OR {CUBE}.VOIDSTTS = 2"
        label: "true"
      else:
        label: "false"

  - name: gl_posted_date
    sql: "{CUBE}.GLPOSTDT"
    type: time

  - name: quote_date
    sql: "{CUBE}.QUOTEDAT"
    type: time

  - name: quote_expiration_date
    sql: "{CUBE}.QUOEXPDA"
    type: time

  - name: order_date
    sql: "{CUBE}.ORDRDATE"
    type: time

  - name: invoice_date
    sql: "{CUBE}.INVODATE"
    type: time

  - name: back_order_date
    sql: "{CUBE}.BACKDATE"
    type: time

  - name: return_date
    sql: "{CUBE}.RETUDATE"
    type: time

  - name: requested_ship_date
    sql: "{CUBE}.ReqShipDate"
    type: time

  - name: fulfillment_date
    sql: "{CUBE}.FUFILDAT"
    type: time

  - name: discount_date
    sql: "{CUBE}.DISCDATE"
    type: time

  - name: due_date
    sql: "{CUBE}.DUEDATE"
    type: time

  - name: posted_date
    sql: "{CUBE}.POSTEDDT"
    type: time

  - name: tax_date
    sql: "{CUBE}.Tax_Date"
    type: time

  - name: sale_date
    sql: "{CUBE}.SALEDATE"
    type: time

  - name: created_at
    sql: "{CUBE}.CREATDDT"
    type: time

  - name: doc_date
    sql: "{CUBE}.DOCDATE"
    type: time

  # - name: last_modified_at
  #   sql:
  #   type: time

  # - name: last_processed_at
  #   sql: "GETUTCDATE()"
  #   type: time

  - name: shipping_method_id
    sql: "{CUBE}.SHIPMTHD"
    type: string

  - name: shipping_city
    sql: "{CUBE}.CITY"
    type: string

  - name: shipping_state
    sql: "{CUBE}.STATE"
    type: string

  - name: shipping_zip
    sql: "{CUBE}.ZIPCODE"
    type: string

  - name: shipping_country
    sql: "{CUBE}.COUNTRY"
    type: string

  - name: shipping_country_code
    sql: "{CUBE}.CCode"
    type: string

  - name: freight_tax_schedule_id
    sql: "{CUBE}.FRTSCHID"
    type: string

  - name: ups_zone
    sql: "{CUBE}.UPSZONE"
    type: string

  - name: is_ship_complete
    sql: "{CUBE}.SHIPCOMPLETE"
    type: boolean

  - name: sales_rep_id
    sql: "{CUBE}.SLPRSNID"
    type: string

  - name: sales_rep_name
    sql: "{CUBE}.SLPRSNID"
    type: string

  - name: customer_number
    sql: "{CUBE}.CUSTNMBR"
    type: string

  - name: customer_name
    sql: "{CUBE}.CUSTNAME"
    type: string

  - name: shipped_at
    sql: "{CUBE}.ACTLSHIP"
    type: time

  # - name: historical_at
  #   sql: "CAST('1900-01-01' AS DATETIME )"
  #   type: time

  measures:
  - name: margin_percent
    sql: "100 * ({CUBE.subtotal_net_discount} - {open_lines.sum_extended_cost}) / {CUBE.subtotal_net_discount}"
    type: number

  - name: margin_dollars
    sql: "{CUBE.subtotal_net_discount} - {open_lines.sum_extended_cost}"
    type: number

  pre_aggregations:
  - name: main
    dimensions:
    - open_documents.account_amount
    - open_documents.back_order_date
    - open_documents.created_at
    - open_documents.customer_name
    - open_documents.customer_number
    - open_documents.deposit_amount_received
    - open_documents.discount
    - open_documents.discount_date
    - open_documents.doc_date
    - open_documents.document_class
    - open_documents.document_type
    - open_documents.due_date
    # - open_documents.extended_cost
    - open_documents.external_id
    - open_documents.external_number
    - open_documents.freight
    - open_documents.freight_tax_amount
    - open_documents.freight_tax_schedule_id
    - open_documents.freight_taxable
    - open_documents.fulfillment_date
    - open_documents.gl_posted_date
    - open_documents.invoice_date
    - open_documents.is_ship_complete
    - open_documents.is_sli_tax_based_on_invoice_total
    - open_documents.is_void
    - open_documents.markdown_amount
    - open_documents.master_number
    - open_documents.misc_amount
    - open_documents.order_date
    - open_documents.orig_document_class
    - open_documents.orig_document_num
    - open_documents.original_external_id
    - open_documents.payment_amount_received
    - open_documents.payment_terms_id
    - open_documents.posted_date
    - open_documents.price_level_id
    - open_documents.quote_date
    - open_documents.quote_expiration_date
    - open_documents.remaining_subtotal
    - open_documents.requested_ship_date
    - open_documents.return_date
    - open_documents.sale_date
    - open_documents.sales_rep_id
    - open_documents.sales_rep_name
    - open_documents.sales_territory_id
    - open_documents.shipped_at
    - open_documents.shipping_city
    - open_documents.shipping_country
    - open_documents.shipping_country_code
    - open_documents.shipping_method_id
    - open_documents.shipping_state
    - open_documents.shipping_zip
    - open_documents.subtotal
    - open_documents.subtotal_net_discount
    - open_documents.tax
    - open_documents.tax_date
    - open_documents.tax_schedule_id
    - open_documents.taxable_tax_amount
    - open_documents.total
    - open_documents.transaction_source
    - open_documents.ups_zone
    - open_documents.warehouse_id

